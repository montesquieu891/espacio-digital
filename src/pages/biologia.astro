---
import Layout from "../core/Layout.astro";
---

<Layout title="Sistemas Emergentes | Game of Life">
    <main
        class="min-h-screen bg-[#0a0a0a] text-[#e5e5e5] p-4 flex flex-col items-center"
    >
        <header
            class="w-full max-w-4xl flex justify-between items-end mb-8 border-b border-neutral-800 pb-4"
        >
            <div>
                <a
                    href="/"
                    class="text-xs text-neutral-500 hover:text-white mb-2 block uppercase tracking-widest"
                    >← Volver</a
                >
                <h1 class="text-3xl font-bold">GAME OF LIFE</h1>
                <p class="text-neutral-500 text-sm font-mono">
                    Autómata Celular // John Conway
                </p>
            </div>
            <div class="text-right hidden md:block">
                <p class="text-xs text-neutral-600">REGLAS:</p>
                <p class="text-xs text-neutral-500">
                    1. &lt; 2 vecinas = muere (soledad)
                </p>
                <p class="text-xs text-neutral-500">
                    2. &gt; 3 vecinas = muere (sobrepoblación)
                </p>
                <p class="text-xs text-neutral-500">
                    3. 3 vecinas = nace (reproducción)
                </p>
            </div>
        </header>

        <div class="w-full max-w-4xl mb-6 flex gap-4">
            <button
                id="btn-play"
                class="bg-white text-black px-6 py-2 font-bold hover:bg-neutral-200 transition-colors uppercase text-sm"
            >
                Iniciar Simulación
            </button>
            <button
                id="btn-clear"
                class="border border-neutral-700 px-6 py-2 text-neutral-400 hover:text-white hover:border-white transition-colors uppercase text-sm"
            >
                Limpiar
            </button>
            <button
                id="btn-random"
                class="border border-neutral-700 px-6 py-2 text-neutral-400 hover:text-white hover:border-white transition-colors uppercase text-sm"
            >
                Aleatorio
            </button>
        </div>

        <div
            class="w-full max-w-4xl flex justify-between text-xs font-mono text-neutral-500 mb-2"
        >
            <span id="gen-count">GENERACIÓN: 0</span>
            <span id="pop-count">POBLACIÓN: 0</span>
        </div>

        <canvas
            id="grid"
            class="border border-neutral-800 cursor-crosshair shadow-2xl shadow-neutral-900"
        ></canvas>

        <script>
            const canvas = document.getElementById("grid");
            const ctx = canvas.getContext("2d");
            const btnPlay = document.getElementById("btn-play");
            const btnClear = document.getElementById("btn-clear");
            const btnRandom = document.getElementById("btn-random");
            const genCountSpan = document.getElementById("gen-count");
            const popCountSpan = document.getElementById("pop-count");

            // Configuración
            const CELL_SIZE = 10;
            const COLS = 80;
            const ROWS = 50;
            let isPlaying = false;
            let intervalId = null;
            let generation = 0;

            // Ajustar tamaño del canvas
            canvas.width = COLS * CELL_SIZE;
            canvas.height = ROWS * CELL_SIZE;

            // Crear matriz (Grid)
            let grid = createGrid();
            let nextGridBuffer = createGrid(); // Doble buffer para rendimiento

            function createGrid() {
                return new Array(COLS)
                    .fill(null)
                    .map(() => new Array(ROWS).fill(0)); // 0 = Muerta, >0 = Edad
            }

            function drawGrid() {
                ctx.fillStyle = "#0a0a0a"; // Fondo
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = "#e5e5e5"; // Células vivas
                let population = 0;
                for (let col = 0; col < COLS; col++) {
                    for (let row = 0; row < ROWS; row++) {
                        const age = grid[col][row];
                        if (age > 0) {
                            ctx.fillStyle = `hsl(${120 + ((age * 5) % 240)}, 70%, ${Math.max(40, 80 - age * 2)}%)`;
                            ctx.fillRect(
                                col * CELL_SIZE,
                                row * CELL_SIZE,
                                CELL_SIZE - 1,
                                CELL_SIZE - 1,
                            );
                            population++;
                        }
                    }
                }

                genCountSpan.textContent = `GENERACIÓN: ${generation}`;
                popCountSpan.textContent = `POBLACIÓN: ${population}`;
            }

            function nextGen() {
                generation++;
                for (let col = 0; col < COLS; col++) {
                    for (let row = 0; row < ROWS; row++) {
                        const cell = grid[col][row];
                        let numNeighbors = 0;

                        // Contar vecinos
                        for (let i = -1; i < 2; i++) {
                            for (let j = -1; j < 2; j++) {
                                if (i === 0 && j === 0) continue;
                                const x_cell = col + i;
                                const y_cell = row + j;

                                if (
                                    x_cell >= 0 &&
                                    y_cell >= 0 &&
                                    x_cell < COLS &&
                                    y_cell < ROWS
                                ) {
                                    if (grid[x_cell][y_cell] > 0)
                                        numNeighbors++;
                                }
                            }
                        }

                        // Reglas de Conway
                        if (cell > 0 && numNeighbors < 2)
                            nextGridBuffer[col][row] = 0;
                        else if (cell > 0 && numNeighbors > 3)
                            nextGridBuffer[col][row] = 0;
                        else if (cell === 0 && numNeighbors === 3)
                            nextGridBuffer[col][row] = 1;
                        else if (cell > 0) nextGridBuffer[col][row] = cell + 1;
                        else nextGridBuffer[col][row] = 0;
                    }
                }
                // Intercambiar buffers (mucho más rápido que crear nuevos arrays)
                [grid, nextGridBuffer] = [nextGridBuffer, grid];
                drawGrid();
            }

            function togglePlay() {
                isPlaying = !isPlaying;
                btnPlay.textContent = isPlaying
                    ? "PAUSAR"
                    : "INICIAR SIMULACIÓN";
                btnPlay.classList.toggle("bg-red-600", isPlaying);
                btnPlay.classList.toggle("text-white", isPlaying);

                if (isPlaying) {
                    intervalId = setInterval(nextGen, 100);
                } else {
                    clearInterval(intervalId);
                }
            }

            // Eventos
            btnPlay.addEventListener("click", togglePlay);

            btnRandom.addEventListener("click", () => {
                grid = grid.map((col) =>
                    col.map(() => (Math.random() > 0.85 ? 1 : 0)),
                );
                generation = 0;
                drawGrid();
            });

            btnClear.addEventListener("click", () => {
                grid = createGrid();
                if (isPlaying) togglePlay();
                generation = 0;
                drawGrid();
            });

            // Interacción con mouse (Click y Arrastre)
            let isDrawing = false;

            function drawCell(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const col = Math.floor(x / CELL_SIZE);
                const row = Math.floor(y / CELL_SIZE);

                if (col >= 0 && col < COLS && row >= 0 && row < ROWS) {
                    grid[col][row] = 1; // Pintar viva
                    drawGrid();
                }
            }

            canvas.addEventListener("mousedown", (e) => {
                isDrawing = true;
                drawCell(e);
            });
            canvas.addEventListener("mousemove", (e) => {
                if (isDrawing) drawCell(e);
            });
            window.addEventListener("mouseup", () => (isDrawing = false));

            // Inicio
            drawGrid();
        </script>
    </main>
</Layout>
